<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lucky Wheel • Live Preview</title>

<style>
:root{
  --gold:#d6b25e;
  --gold2:#f2d27a;
  --text:#f5f5f5;
  --muted:rgba(245,245,245,.70);
  --line:rgba(214,178,94,.25);
  --shadow:0 30px 90px rgba(0,0,0,.75);
  --panel:rgba(0,0,0,.55);
}

*{box-sizing:border-box}
body{
  margin:0;
  height:100vh;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:#050507;
  color:var(--text);
  overflow:hidden;
}

/* background */
.bg{
  position:fixed;
  inset:0;
  background: radial-gradient(circle at center, rgba(214,178,94,.12), rgba(0,0,0,.95) 70%);
}

/* layout */
.wrap{
  position:relative;
  z-index:1;
  height:100vh;
  display:grid;
  grid-template-columns: 340px 1fr;
  padding:20px;
  gap:20px;
}

/* LEFT: PRIZES */
.prizes{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:18px;
  padding:18px;
  box-shadow:var(--shadow);
  display:flex;
  flex-direction:column;
  min-height:0;
}
.prizes h2{
  margin:0 0 12px;
  font-size:14px;
  letter-spacing:.14em;
  text-transform:uppercase;
  color:var(--gold2);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
}
.prizes .small{
  font-size:11px;
  color:rgba(245,245,245,.55);
  letter-spacing:.08em;
  text-transform:uppercase;
}
.prizeList{
  overflow:auto;
  padding-right:6px;
}
.prizeItem{
  padding:10px 12px;
  border-bottom:1px solid rgba(214,178,94,.18);
  font-weight:800;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
}
.prizeItem:last-child{border-bottom:none}
.prizeLabel{
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.prizeMeta{
  font-size:12px;
  color:rgba(245,245,245,.72);
  flex:0 0 auto;
}

/* highlight winner prize */
.prizeItem.win{
  background: rgba(214,178,94,.14);
  border:1px solid rgba(214,178,94,.35);
  border-radius:14px;
  margin:6px 0;
  box-shadow: 0 0 0 3px rgba(214,178,94,.07), 0 18px 50px rgba(0,0,0,.45);
}
.prizeItem.win .prizeLabel{ color: var(--gold2); }
.prizeItem.win .prizeMeta{ color: rgba(242,210,122,.95); }

/* CENTER */
.center{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  position:relative;
  min-height:0;
}

/* Wheel wrap */
.wheelWrap{
  position:relative;
  width:min(62vh,62vw);
  aspect-ratio:1;
  display:grid;
  place-items:center;
}

/* ✅ Cropped logo above wheel (better crop) */
.wheelTopLogo{
  position:absolute;
  top:-88px;
  left:50%;
  transform:translateX(-50%);

  width:520px;     /* change size here */
  height:110px;    /* crop height */

  object-fit:cover;
  object-position:center 48%;
  border-radius: 14px;

  z-index:12;
  pointer-events:none;

  filter:
    drop-shadow(0 10px 22px rgba(0,0,0,.85))
    drop-shadow(0 0 36px rgba(214,178,94,.45));
}

/* Pointer */
.pointer{
  position:absolute;
  top:-18px;
  left:50%;
  transform:translateX(-50%);
  width:0;height:0;
  border-left:18px solid transparent;
  border-right:18px solid transparent;
  border-bottom:28px solid var(--gold2);
  filter:drop-shadow(0 6px 10px rgba(0,0,0,.6));
  z-index:10;
}

/* Outer ring glow */
.ring{
  position:absolute;
  inset:-10px;
  border-radius:50%;
  border:3px solid rgba(214,178,94,.28);
  box-shadow: 0 0 140px rgba(214,178,94,.22);
  pointer-events:none;
}

/* Canvas wheel */
#wheelCanvas{
  width:100%;
  height:100%;
  border-radius:50%;
  border:4px solid rgba(214,178,94,.45);
  background: radial-gradient(circle at center, rgba(255,255,255,.06), rgba(0,0,0,.82));
  box-shadow:
    0 0 120px rgba(214,178,94,.35),
    inset 0 0 40px rgba(0,0,0,.85);
  transform: rotate(0deg);
  transition: transform 2.8s cubic-bezier(.2,.8,.2,1);
}

/* Winner below */
.winnerPanel{
  margin-top:18px;
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:18px;
  padding:16px 26px;
  text-align:center;
  box-shadow:var(--shadow);
  min-width:min(620px, 92vw);
}
.winnerLabel{
  font-size:12px;
  letter-spacing:.14em;
  text-transform:uppercase;
  color:var(--muted);
}
.winnerName{
  font-size:clamp(28px, 3.6vw, 44px);
  font-weight:1000;
  margin-top:4px;
}
.winnerPrize{
  font-size:clamp(20px, 2.6vw, 32px);
  font-weight:900;
  color:var(--gold2);
  margin-top:4px;
}
.winnerSub{
  margin-top:6px;
  font-size:13px;
  color:rgba(245,245,245,.70);
}

/* Status + buttons */
.status{
  position:fixed;
  bottom:18px;
  left:18px;
  font-size:12px;
  color:rgba(245,245,245,.6);
  display:flex;
  align-items:center;
  gap:8px;
  z-index:60;
}
.dot{
  width:10px;height:10px;border-radius:50%;
  background:#888;
}
.dot.ok{background:#a6ffc8}
.dot.bad{background:#ffb3b3}

.controls{
  position:fixed;
  bottom:14px;
  right:18px;
  display:flex;
  gap:10px;
  z-index:60;
}
.btn{
  padding:8px 14px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(214,178,94,.08);
  color:var(--gold2);
  cursor:pointer;
  font-weight:900;
}

/* FX layer */
.fx{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:55;
  overflow:hidden;
}
.confetti{
  position:absolute;
  top:-12px;
  width:10px;
  height:16px;
  border-radius:2px;
  opacity:.95;
  animation: fall linear forwards;
}
@keyframes fall{
  to{
    transform: translateY(calc(100vh + 40px)) rotate(720deg);
    opacity:.9;
  }
}
.spark{
  position:absolute;
  width:6px;
  height:6px;
  border-radius:50%;
  background: rgba(242,210,122,1);
  box-shadow: 0 0 14px rgba(242,210,122,.9);
  animation: spark 900ms ease-out forwards;
}
@keyframes spark{
  0%{ transform: translate(0,0) scale(1); opacity:1; }
  100%{ transform: translate(var(--dx), var(--dy)) scale(.2); opacity:0; }
}

/* responsive tweaks */
@media (max-width:900px){
  .wrap{ grid-template-columns: 280px 1fr; }
  .wheelTopLogo{ width:420px; height:95px; top:-72px; }
}
</style>
</head>

<body>
<div class="bg"></div>

<div class="wrap">

  <!-- LEFT: PRIZES -->
  <aside class="prizes">
    <h2>
      <span>Prizes</span>
      <span class="small" id="prizeCount">—</span>
    </h2>
    <div class="prizeList" id="prizeList">Loading…</div>
  </aside>

  <!-- CENTER -->
  <main class="center">
    <section class="wheelWrap">
      <img src="/assets/eventlogo.png" class="wheelTopLogo" alt="Millionaires Group Concierge" />
      <div class="pointer"></div>
      <div class="ring"></div>
      <canvas id="wheelCanvas"></canvas>
    </section>

    <section class="winnerPanel">
      <div class="winnerLabel">Current Winner</div>
      <div id="winnerName" class="winnerName">—</div>
      <div id="winnerPrize" class="winnerPrize">—</div>
      <div id="winnerSub" class="winnerSub">Waiting for latest result…</div>
    </section>
  </main>
</div>

<div class="status">
  <span id="dot" class="dot"></span>
  <span id="statusText">Loading…</span>
</div>

<div class="controls">
  <button class="btn" id="btnRefresh">Refresh</button>
  <button class="btn" id="btnFullscreen">Fullscreen</button>
</div>

<div class="fx" id="fxLayer"></div>

<script>
const POLL_MS = 3000;
const PRIZE_REFRESH_MS = 20000;
const POINTER_ANGLE_DEG = -90;

const prizeListEl = document.getElementById("prizeList");
const prizeCountEl = document.getElementById("prizeCount");
const winnerNameEl = document.getElementById("winnerName");
const winnerPrizeEl = document.getElementById("winnerPrize");
const winnerSubEl = document.getElementById("winnerSub");
const dot = document.getElementById("dot");
const statusText = document.getElementById("statusText");
const fxLayer = document.getElementById("fxLayer");

const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");

let prizes = [];
let lastSpinId = null;
let spinning = false;
let currentRotation = 0;
let audioCtx = null;

async function http(path){
  const res = await fetch(path);
  if(!res.ok) throw new Error(res.statusText);
  return res.json();
}

function escapeHtml(str){
  if (str == null) return "";
  return String(str)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

function fmtPrizeMeta(p){
  const t = ({1:"Percent",2:"Amount",3:"Free Spin",4:"Gift"})[p.type] || "";
  if (p.type === 1) return `${Number(p.value||0)}%`;
  if (p.type === 3) return `Free Spins`;
  if (p.type === 4) return `Gift`;
  return `${Number(p.value||0).toFixed(2)} ${p.currency || ""}`.trim();
}

function renderPrizeList(highlightLabel){
  const hi = (highlightLabel || "").trim().toLowerCase();

  if (!prizes.length){
    prizeListEl.innerHTML = `<div class="prizeItem"><span class="prizeLabel">No prizes available</span></div>`;
    prizeCountEl.textContent = "0";
    return;
  }

  prizeCountEl.textContent = String(prizes.length);

  prizeListEl.innerHTML = prizes.map(p=>{
    const isWin = hi && (p.label || "").trim().toLowerCase() === hi;
    return `
      <div class="prizeItem ${isWin ? "win" : ""}">
        <span class="prizeLabel">${escapeHtml(p.label)}</span>
        <span class="prizeMeta">${escapeHtml(fmtPrizeMeta(p))}</span>
      </div>
    `;
  }).join("");

  if (hi){
    const winEl = prizeListEl.querySelector(".prizeItem.win");
    if (winEl) winEl.scrollIntoView({block:"center", behavior:"smooth"});
  }
}

/* ---- segmented wheel (canvas) ---- */
function resizeCanvas(){
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.floor(rect.width * dpr);
  canvas.height = Math.floor(rect.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  drawWheel();
}
window.addEventListener("resize", resizeCanvas);

function drawWheel(){
  const w = canvas.getBoundingClientRect().width;
  const h = canvas.getBoundingClientRect().height;
  if (!w || !h) return;

  const cx = w/2, cy = h/2;
  const radius = Math.min(w,h)*0.46;

  ctx.clearRect(0,0,w,h);

  // rim
  ctx.beginPath();
  ctx.arc(cx,cy,radius+10,0,Math.PI*2);
  ctx.strokeStyle = "rgba(214,178,94,.18)";
  ctx.lineWidth = 10;
  ctx.stroke();

  if (!prizes.length){
    ctx.beginPath();
    ctx.arc(cx,cy,radius,0,Math.PI*2);
    ctx.strokeStyle = "rgba(214,178,94,.25)";
    ctx.lineWidth = 2;
    ctx.stroke();
    return;
  }

  const n = prizes.length;
  const slice = (Math.PI*2) / n;

  for (let i=0;i<n;i++){
    const a0 = i*slice;
    const a1 = a0 + slice;

    const alt = i % 2 === 0;
    const base = alt ? "rgba(214,178,94,.18)" : "rgba(255,255,255,.06)";

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,radius,a0,a1);
    ctx.closePath();
    ctx.fillStyle = base;
    ctx.fill();

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.lineTo(cx + Math.cos(a0)*radius, cy + Math.sin(a0)*radius);
    ctx.strokeStyle = "rgba(214,178,94,.28)";
    ctx.lineWidth = 2;
    ctx.stroke();

    const mid = (a0+a1)/2;
    const tx = cx + Math.cos(mid) * (radius*0.68);
    const ty = cy + Math.sin(mid) * (radius*0.68);

    ctx.save();
    ctx.translate(tx,ty);
    ctx.rotate(mid + Math.PI/2);

    ctx.fillStyle = "rgba(245,245,245,.90)";
    ctx.font = "800 14px system-ui,Segoe UI,Roboto,Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    const label = prizes[i].label || "";
    const short = label.length > 18 ? label.slice(0,18) + "…" : label;

    ctx.strokeStyle = "rgba(0,0,0,.55)";
    ctx.lineWidth = 4;
    ctx.strokeText(short, 0, 0);
    ctx.fillText(short, 0, 0);

    ctx.restore();
  }

  // center cap
  ctx.beginPath();
  ctx.arc(cx,cy,radius*0.18,0,Math.PI*2);
  ctx.fillStyle = "rgba(0,0,0,.55)";
  ctx.fill();
  ctx.strokeStyle = "rgba(214,178,94,.35)";
  ctx.lineWidth = 3;
  ctx.stroke();
}

function findPrizeIndexByLabel(label){
  const t = (label || "").trim().toLowerCase();
  return prizes.findIndex(p => (p.label || "").trim().toLowerCase() === t);
}

function angleForPrizeIndex(i){
  const n = prizes.length || 1;
  const sliceDeg = 360 / n;
  const centerOfSliceDeg = (i * sliceDeg) + (sliceDeg/2);
  return (POINTER_ANGLE_DEG - centerOfSliceDeg);
}

function setWheelRotation(deg){
  currentRotation = deg;
  canvas.style.transform = `rotate(${deg}deg)`;
}

function spinToPrize(label){
  if(spinning) return;

  let idx = findPrizeIndexByLabel(label);
  if (idx < 0) idx = Math.floor(Math.random() * Math.max(prizes.length,1));

  const target = angleForPrizeIndex(idx);
  const extraTurns = 4 + Math.floor(Math.random()*3);
  const finalDeg = (extraTurns * 360) + target;

  spinning = true;
  const next = currentRotation + finalDeg;
  setWheelRotation(next);

  setTimeout(()=>{
    spinning = false;
    playStopSound();
    burstFX();
  }, 2850);
}

/* ---- FX ---- */
function burstFX(){
  const count = 90;
  for (let i=0;i<count;i++){
    const c = document.createElement("div");
    c.className = "confetti";
    c.style.left = (Math.random()*100) + "vw";
    c.style.animationDuration = (1.8 + Math.random()*1.6) + "s";
    c.style.animationDelay = (Math.random()*0.15) + "s";
    c.style.transform = `translateY(0) rotate(${Math.random()*360}deg)`;
    c.style.background = (Math.random() < 0.65) ? "rgba(242,210,122,.95)" : "rgba(255,255,255,.92)";
    c.style.width = (6 + Math.random()*8) + "px";
    c.style.height = (10 + Math.random()*14) + "px";
    fxLayer.appendChild(c);
    setTimeout(()=>c.remove(), 4000);
  }

  const rect = canvas.getBoundingClientRect();
  const cx = rect.left + rect.width/2;
  const cy = rect.top + rect.height/2;

  for (let i=0;i<26;i++){
    const s = document.createElement("div");
    s.className = "spark";
    s.style.left = cx + "px";
    s.style.top = cy + "px";
    const ang = Math.random()*Math.PI*2;
    const dist = 120 + Math.random()*180;
    s.style.setProperty("--dx", (Math.cos(ang)*dist) + "px");
    s.style.setProperty("--dy", (Math.sin(ang)*dist) + "px");
    fxLayer.appendChild(s);
    setTimeout(()=>s.remove(), 1100);
  }
}

/* ---- SOUND ---- */
function ensureAudio(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function playStopSound(){
  try{
    ensureAudio();
    const now = audioCtx.currentTime;

    const o1 = audioCtx.createOscillator();
    const g1 = audioCtx.createGain();
    o1.type = "sine";
    o1.frequency.setValueAtTime(880, now);
    o1.frequency.exponentialRampToValueAtTime(1320, now + 0.18);
    g1.gain.setValueAtTime(0.0001, now);
    g1.gain.exponentialRampToValueAtTime(0.22, now + 0.02);
    g1.gain.exponentialRampToValueAtTime(0.0001, now + 0.22);
    o1.connect(g1).connect(audioCtx.destination);
    o1.start(now);
    o1.stop(now + 0.25);

    const o2 = audioCtx.createOscillator();
    const g2 = audioCtx.createGain();
    o2.type = "triangle";
    o2.frequency.setValueAtTime(660, now + 0.03);
    o2.frequency.exponentialRampToValueAtTime(990, now + 0.20);
    g2.gain.setValueAtTime(0.0001, now + 0.03);
    g2.gain.exponentialRampToValueAtTime(0.16, now + 0.05);
    g2.gain.exponentialRampToValueAtTime(0.0001, now + 0.24);
    o2.connect(g2).connect(audioCtx.destination);
    o2.start(now + 0.03);
    o2.stop(now + 0.28);
  }catch{}
}
window.addEventListener("pointerdown", () => {
  try{
    ensureAudio();
    if (audioCtx && audioCtx.state === "suspended") audioCtx.resume();
  }catch{}
}, { once:true });

/* ---- DATA LOAD ---- */
async function loadPrizes(){
  try{
    const rows = await http("/api/events/prizes");
    prizes = (rows || []).filter(p => p.isEnabled).sort((a,b)=> (a.sortOrder||0)-(b.sortOrder||0));
    renderPrizeList(null);
    resizeCanvas();
  }catch{
    prizes = [];
    renderPrizeList(null);
    resizeCanvas();
  }
}

async function loadLatest(){
  try{
    const rows = await http("/api/events/spins/recent?take=1");
    dot.className = "dot ok";
    statusText.textContent = "Live";

    if (!rows || !rows.length){
      winnerSubEl.textContent = "No spins yet.";
      return;
    }

    const r = rows[0];

    winnerNameEl.textContent = r.customerNameSnapshot ?? "—";
    winnerPrizeEl.textContent = r.prizeLabelSnapshot ?? "—";
    winnerSubEl.textContent =
      `${({1:"Percent Bonus",2:"Fixed Amount",3:"Free Spin",4:"Gift"})[r.prizeTypeSnapshot] || ""} • ` +
      `${Number(r.prizeValueSnapshot || 0).toFixed(2)} ${r.currencySnapshot || ""}`.trim();

    if (lastSpinId !== r.id){
      lastSpinId = r.id;
      renderPrizeList(r.prizeLabelSnapshot);
      spinToPrize(r.prizeLabelSnapshot);
    } else {
      renderPrizeList(r.prizeLabelSnapshot);
    }

  }catch{
    dot.className = "dot bad";
    statusText.textContent = "Offline";
  }
}

/* controls */
document.getElementById("btnRefresh").onclick = async () => {
  await loadPrizes();
  await loadLatest();
};
document.getElementById("btnFullscreen").onclick = async () => {
  try{
    if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
    else await document.exitFullscreen();
  }catch{}
};

/* init */
(async function init(){
  await loadPrizes();
  await loadLatest();
  setInterval(loadLatest, POLL_MS);
  setInterval(loadPrizes, PRIZE_REFRESH_MS);
})();
</script>
</body>
</html>
